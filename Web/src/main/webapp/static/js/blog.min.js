let bid=getUrlParam("bid");let replyCid;let editId;$.getJSON("/api/blog/info/"+bid,function(a){$("title").text(a.title+" - DOJ");$("#blogTitle").html(HTML.b(a.title));if(a.is_author===1){$("#blogTitle").append(HTML.frontSR(HTML.a("javascript:delBlog()",HTML.bS("color: red;","[删除博文]"))));$("#Blog table tbody td.replyRight").append('<div class="replyLink" style=\'float: right;\'><a href="editblog.jsp?bid='+bid+'">编辑</a></div>')}let st=a.username.split("|");let newU=st[1]+"|"+st[3];if(a.image!=null){$("#blogInfo div img").attr("src",a.image)}$("#blogUsername").html(HTML.a("/userinfo.jsp?uid="+a.uid,getStyleName(newU)));$("#blogText").html(a.text);let blogFooter=$("#blogFooter");blogFooter.append(HTML.frontSL(getVote(0,a.up_vote,a.down_vote,a.my_vote)));blogFooter.append(HTML.frontSR("Written by "+getStyleName(a.username)+" at "+a.date+", "+a.num+" replies."));blogFooter.append("<br />");if(a.iscollect){$("#blogCollect").text("已收藏")}loadComments()});function hLight(){$("pre code").each(function(a,b){hljs.highlightBlock(b)});$("code").each(function(){$(this).html("<ol><li>"+$(this).html().replace(/\n/g,"\n</li><li>")+"\n</li></ol>")});window.MathJax.Hub.Queue(["Typeset",MathJax.Hub])}function loadComments(){$.getJSON("/api/blog/comments/"+bid,function(a){let comments=$("#Commtents");comments.empty();let fl=0;for(let i=0;i<a.length;i++){if(a[i].precid===-1){fl++;comments.append(newComment(fl,a[i]))}else{$("#"+a[i].precid+" div.reply").append(newReply(a[i])+"<hr />")}}hLight()})}function newComment(b,a){let del="";let edit="";if(a.is_author){del=HTML.a("javascript:delComment("+a.cid+")",HTML.bS("color: red","[删除]"));edit='<div class="replyLink" style=\'float: right;\'><a href="#blogCEdit" data-toggle="modal" onclick="setEdit('+a.cid+')">编辑</a></div>'}let st=a.username.split("|");let newU=st[1]+"|"+st[3];let res='<div class="panel panel-default" style="word-break: break-all;" id="'+a.cid+'"><div class="panel-heading"><a href="#'+a.cid+'">#'+b+"&nbsp;</a>reply by "+getStyleName(a.username)+" at "+a.date+"&nbsp;&nbsp;"+del+'<front style="float: right">'+getVote(a.cid,a.up_vote,a.down_vote,a.my_vote)+'</front></div><table style="width: 100%"><tbody><tr><td class="replyInfo"><div><img src="'+a.image+'" onerror="this.src=\'/media/user/default.jpg\'"></div><div style="text-align: center;">'+getStyleName(newU)+'</div></td><td class="replyRight"><div class="replyText">'+a.text+'</div><div class="reply"></div><div class="replyLink"><a href="#blogReply" data-toggle="modal" onclick="setReply('+a.cid+')">回复</a></div>'+edit+"</td></tr></tbody></table></div>";return res}function newReply(a){let res='<div class="replyreply" id="'+a.cid+'"><front style="float: left"><img src="'+a.image+'" onerror="this.src=\'/media/user/default.jpg\'" /></front><div>'+getStyleName(a.username)+"：<p>"+a.text+"</p></div><div>"+a.date+"</div></div>";return res}function blogCollect(){$.ajax({url:"/api/blog/collect/"+bid,type:"PUT",contentType:"application/json",dataType:"json",success:function(a){if(a.state===0){narn("success","收藏成功")}else{if(a.state===1){narn("log","你还没有登陆")}else{if(a.state===2){narn("log","取消收藏成功")}}}}})}function setEdit(a){if(!a||a==""){a=""}editId=a;tinyMCE.editors.editor1.setContent($("#"+a+" .replyText:first").html())}function setReply(a){if(!a||a==""){a=""}replyCid=a}function reply(){let cid=replyCid;$.ajax({url:"/api/blog/reply?bid="+bid+"&cid="+cid,type:"POST",contentType:"application/json",dataType:"json",data:JSON.stringify({text:tinyMCE.editors.editor.getContent()}),success:function(a){if(a.state==0){narn("success","成功");loadComments()}else{narn("log","回复失败")}}})}function addStar(a){if(a==0){$.ajax({url:"/api/blog/upvote?bid="+bid,type:"POST",contentType:"application/json",dataType:"json",success:function(b){if(b.state==0){narn("success","点赞成功！")}else{narn("log","您现在不能投票！")}}})}else{$.ajax({url:"/api/blog/comments/upvote?bid="+bid+"&id="+a,type:"POST",contentType:"application/json",dataType:"json",success:function(b){if(b.state==0){narn("success","点赞成功！");loadComments()}else{narn("log","您现在不能投票！")}}})}}function subStar(a){if(a==0){$.ajax({url:"/api/blog/downvote?bid="+bid,type:"POST",contentType:"application/json",dataType:"json",success:function(b){if(b.state==0){narn("success","点踩成功")}else{narn("log","您现在不能投票")}}})}else{$.ajax({url:"/api/blog/comments/downvote?bid="+bid+"&id="+a,type:"POST",contentType:"application/json",dataType:"json",success:function(b){if(b.state==0){narn("success","点踩成功");loadComments()}else{narn("log","您现在不能投票")}}})}}function delComment(a){let flag=confirm("确定删除？本操作不可撤销！");if(flag){$.ajax({url:"/api/blog/delete?bid="+bid+"&cid="+a,type:"POST",contentType:"application/json",dataType:"json",success:function(b){if(b.state==0){narn("log","删除成功");loadComments()}else{narn("log","删除失败")}}})}}function delBlog(){let flag=confirm("确定删除本篇？本操作不可撤销！");if(flag){$.ajax({url:"/api/blog/delete?bid="+bid,type:"POST",contentType:"application/json",dataType:"json",success:function(a){if(a.state==0){location.href="blogs.jsp#sdelete"}else{narn("log","删除失败")}}})}}function CEdit(){$.ajax({url:"/api/blog/comment/edit?cid="+editId,type:"POST",contentType:"application/json",dataType:"json",data:JSON.stringify({text:tinyMCE.editors.editor1.getContent()}),success:function(a){if(a.state==0){narn("success","修改成功");loadComments()}else{narn("log","修改失败")}}})}const BlogDirectory={getElementPosition:function(a){let topPosition=0;let leftPosition=0;while(a){topPosition+=a.offsetTop;leftPosition+=a.offsetLeft;a=a.offsetParent}return{top:topPosition,left:leftPosition}},getScrollBarPosition:function(){return document.body.scrollTop||document.documentElement.scrollTop},moveScrollBar:function(b,c){if(!window.scrollTo){return false}window.onmousewheel=function(){return false};if(document.body.movement){clearTimeout(document.body.movement)}let currentpos=BlogDirectory.getScrollBarPosition();let dist=0;if(currentpos===b){window.onmousewheel=function(){return true};return true}if(currentpos<b){dist=Math.ceil((b-currentpos)/10);currentpos+=dist}if(currentpos>b){dist=Math.ceil((currentpos-b)/10);currentpos-=dist}const a=BlogDirectory.getScrollBarPosition();window.scrollTo(0,currentpos);if(BlogDirectory.getScrollBarPosition()===a){window.onmousewheel=function(){return true};return true}const d="BlogDirectory.moveScrollBar("+b+","+c+")";document.body.movement=setTimeout(d,c)},htmlDecode:function(b){let temp=document.createElement("div");temp.innerHTML=b;const a=temp.innerText||temp.textContent;temp=null;return a},createBlogDirectory:function(d,b,o,e){const f=document.getElementById(d);if(!f){return false}const c=f.getElementsByTagName("*");const a=document.createElement("DIV");a.className="uprightsideBar";a.setAttribute("id","uprightsideBar");const n=document.createElement("DIV");n.setAttribute("id","sideBarTab");a.appendChild(n);const l=document.createElement("H2");n.appendChild(l);const h=document.createTextNode("目录导航");l.appendChild(h);const k=document.createElement("DIV");k.style.display="none";k.setAttribute("id","sideBarContents");a.appendChild(k);const m=document.createElement("dl");k.appendChild(m);let num=0;b=b.toUpperCase();o=o.toUpperCase();for(var g=0;g<c.length;g++){if(c[g].nodeName==b||c[g].nodeName==o){let nodetext=c[g].innerHTML.replace(/<\/?[^>]+>/g,"");nodetext=nodetext.replace(/ /ig,"");nodetext=BlogDirectory.htmlDecode(nodetext);c[g].setAttribute("id","blogTitle"+num);let item;switch(c[g].nodeName){case b:item=document.createElement("dt");break;case o:item=document.createElement("dd");break}const j=document.createTextNode(nodetext);item.appendChild(j);item.setAttribute("name",num);item.onclick=function(){const p=BlogDirectory.getElementPosition(document.getElementById("blogTitle"+this.getAttribute("name")));if(!BlogDirectory.moveScrollBar(p.top,e)){return false}};m.appendChild(item);num++}}if(num===0){return false}n.onmouseenter=function(){k.style.display="block"};a.onmouseleave=function(){k.style.display="none"};document.body.appendChild(a)}};window.onload=function(){BlogDirectory.createBlogDirectory("blogText","h1","h2",10)};