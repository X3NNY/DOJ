let pid=getUrlParam("pid");let problemInfo;let langList=["GCC","G++","JAVA","Python"];let replyCid;let bid=-1;if(pid===""||pid==null){pid=1}$.getJSON("/api/problem?pid="+pid,function(a){problemInfo=a;init();loadComment();if($("#tab3 table").length!==0){loadTab3()}});function init(){$("title").text(problemInfo.title+" - DOJ");$("#problemTitle").text(pid+" - "+problemInfo.title);$("#problemInput").html(problemInfo.input);$("#problemOutput").html(problemInfo.output);$("#problemSampleInput").html(problemInfo.sampleinput);$("#problemSampleOutput").html(problemInfo.sampleoutput);$("#problemDesc").html(problemInfo.desc);$("#problemTimeLimit").text(problemInfo.timelimit);$("#problemMemoryLimit").text(problemInfo.memorylimit);if(problemInfo.state===1){$("#problemIsSubmit").html('<font color="green"><span class="glyphicon glyphicon-ok"></span>已AC</font>')}else{if(problemInfo.state===2){$("#problemIsSubmit").html('<font color="red"><span class="glyphicon glyphicon-remove"></span>未AC</font>')}}if(problemInfo.collect){$("#problemIsCollection").html('<font color="green"><span class="glyphicon glyphicon-star"></span>已收藏</font>')}if(problemInfo.hint==null||problemInfo.hint===""){$("#problemHint").parent().hide()}else{$("#problemHint").html(problemInfo.hint)}switch(problemInfo.type){case 0:$("#problemType").text("传统题");break;case 1:$("#problemType").text("交互题");break;case 2:$("#problemType").text("接口实现题");break;case 3:$("#problemType").text("提交答案题");break}$("#problemSpecial").text(problemInfo.special?"Yes":"No");$("#problemAuthor").html(getStyleName(problemInfo.username));$.getJSON("/api/submit?pid="+pid,function(a){$("#problemSelect").text(problemInfo.title);let problemLang=$("#problemLang");problemLang.empty();let blacklist=[];for(let i=0;i<a.length;i++){blacklist.append(a[i])}for(let i=0;i<langList.length;i++){if(blacklist.indexOf(langList[i])===-1){problemLang.append(HTML.option(langList[i]))}}});$.getJSON("/api/problem/info/"+pid,function(a){if(a.tag!=null&&a.tag.length!==0){let tagBody=$("#problemTag tbody");tagBody.empty();a.tag.sort(function(d,c){return d.cnt<c.cnt});for(let i=0;i<a.tag.length;i++){let tag=a.tag[i];if(tag.state===1){tagBody.append(HTML.trClass("success",HTML.td(tag.tag)+HTML.td(tag.tag)))}else{tagBody.append(HTML.tr(HTML.td(tag.tag)+HTML.td(tag.tag)))}}}loadAcPic(a)})}function loadAcPic(a){let all_cnt=a.ac_cnt+a.wa_cnt+a.tle_cnt+a.mle_cnt+a.re_cnt+a.se_cnt+a.ce_cnt+a.pe_cnt+a.ole_cnt;let colors=Highcharts.getOptions().colors,browserData=[{name:"AC",y:a.all_cnt===0?0:(a.ac_cnt/all_cnt*100).toFixed(2)*1,color:colors[2]},{name:"Other",y:a.all_cnt===0?0:((1-a.ac_cnt/all_cnt)*100).toFixed(2)*1,color:colors[4]}],versionsData=[{name:"AC",y:a.all_cnt===0?0:(a.ac_cnt/all_cnt*100).toFixed(2)*1,color:colors[2]},{name:"RE",y:a.all_cnt===0?0:(a.re_cnt/all_cnt*100).toFixed(2)*1,color:colors[8]},{name:"MLE",y:a.all_cnt===0?0:(a.mle_cnt/all_cnt*100).toFixed(2)*1,color:colors[4]},{name:"WA",y:a.all_cnt===0?0:(a.wa_cnt/all_cnt*100).toFixed(2)*1,color:colors[8]},{name:"TLE",y:a.all_cnt===0?0:(a.tle_cnt/all_cnt*100).toFixed(2)*1,color:colors[3]},{name:"OLE",y:a.all_cnt===0?0:(a.ole_cnt/all_cnt*100).toFixed(2)*1,color:colors[6]},{name:"CE",y:a.all_cnt===0?0:(a.ce_cnt/all_cnt*100).toFixed(2)*1,color:colors[7]},{name:"SE",y:a.all_cnt===0?0:(a.se_cnt/all_cnt*100).toFixed(2)*1,color:colors[8]}];Highcharts.chart("picMessage",{chart:{type:"pie"},title:{text:null},subtitle:{text:""},yAxis:{title:{text:""}},plotOptions:{pie:{shadow:false,center:["50%","50%"]}},tooltip:{valueSuffix:"%"},series:[{name:"提交占比",data:browserData,size:"60%",dataLabels:{formatter:function(){return this.y>5?this.point.name:null},color:"#ffffff",distance:-30}},{name:"提交占比",data:versionsData,size:"100%",innerSize:"60%",dataLabels:{formatter:function(){return this.y>2?"<b>"+this.point.name+"</b> ":null},distance:-20}}]})}function proSubmit(){let code=addSlashes($("#problemCode").val());if(code.length>=15000){narn("log","代码长度不能大于15000")}else{$.ajax({url:"/api/submit?pid="+pid,type:"POST",contentType:"application/json",dataType:"json",data:JSON.stringify({lang:$("#problemLang option:selected").text(),code:code}),success:function(a){if(a.state===0){narn("success","提交成功");location.href="/status.jsp"}else{if(a.state===1){location.href="/userlogin.jsp"}else{if(a.state===2){narn("error","提交失败")}}}}})}}function loadComment(){$("#problemDisBlog").hide();$.getJSON("/api/problem/discuss/"+pid,function(a){let problemDiscuss=$("#problemDiscuss tbody");for(let i=0;i<a.length;i++){let tp=a[i];problemDiscuss.append(HTML.tr(HTML.td(tp.bid)+HTML.tdC(HTML.a("javascript:showDiscuss("+tp.bid+")",tp.title))+HTML.tdC(getStyleName(tp.username))+HTML.tdC(tp.date)+getVote(tp.bid,tp.up_vote,tp.down_vote,tp.my_vote)))}})}function showDiscuss(a){$("#problemDiscuss").hide();$("#problemDisBlog").show();$("#problemDiscussTitle").html('评论<front style="float: right"><a href="javascript:returnDis()">返回</a></front>');bid=a;$.getJSON("/api/blog/info/"+bid,function(b){$("#blogTitle").html(HTML.b(b.title));$("#blogTitle").append('<front style="float: right;"><a href="blog.jsp?bid='+bid+'"><span class="glyphicon glyphicon-arrow-right" style="color: #fff;"></span></a></front>');if(b.image!=null){$("#blogInfo div img").attr("src",b.image)}$("#blogUsername").html(HTML.a("/userinfo.jsp?uid="+b.uid,getStyleName(b.username)));$("#blogText").html(b.text);let blogFooter=$("#blogFooter");blogFooter.empty();blogFooter.append(HTML.frontSL(getVote(0,b.up_vote,b.down_vote,b.my_vote)));blogFooter.append(HTML.frontSR("Written by "+getStyleName(b.username)+" at "+b.date+", "+b.num+" replies."));blogFooter.append("<br />");loadBlogComments()})}function returnDis(){$("#problemDisBlog").hide();$("#problemDiscuss").show();$("#problemDiscussTitle").text("所有评论");bid=-1}function loadBlogComments(){$.getJSON("/api/blog/comments/"+bid,function(a){let comments=$("#Commtents");comments.empty();let fl=0;for(let i=0;i<a.length;i++){if(a[i].precid===-1){fl++;comments.append(newComment(fl,a[i]))}else{$("#"+a[i].precid+" div.reply").append(newReply(a[i]))}}})}function newComment(b,a){return'<div class="panel panel-default" style="word-break: break-all;" id="'+a.cid+'"><div class="panel-heading"><a href="#'+a.cid+'">#'+b+"&nbsp;</a>reply by "+getStyleName(a.username)+" at "+a.date+'<front style="float: right">'+getVote(a.cid,a.up_vote,a.down_vote,a.my_vote)+'</front></div><table style="width: 100%"><tbody><tr><td class="replyInfo"><div><img src="'+a.image+'" onerror="this.src=\'/media/user/default.jpg\'"></div><div style="text-align: center;">'+getStyleName(a.username)+'</div></td><td class="replyRight"><div class="replyText">'+a.text+'</div><div class="reply"></div><div class="replyLink"><a href="#blogReply" data-toggle="modal" onclick="setReply('+a.cid+')">回复</a></div></td></tr></tbody></table></div>'}function newReply(a){return'<div class="replyreply" id="'+a.cid+'"><front style="float: left"><img src="'+a.image+'" onerror="this.src=\'/media/user/default.jpg\'" /></front><div>'+getStyleName(a.username)+"：<p>"+a.text+"</p></div><div>"+a.date+"</div></div>"}function setReply(a){if(!a||a===""){a=""}replyCid=a}function reply(){$.ajax({url:"/api/blog/reply?bid="+bid+"&cid="+replyCid,type:"POST",contentType:"application/json",dataType:"json",data:JSON.stringify({text:tinyMCE.editors.editor.getContent()}),success:function(a){if(a.state===0){narn("success","成功");loadComments()}else{narn("log","回复失败")}}})}function addStar(a){if(a===0||bid===-1){let t=bid===-1?a:bid;$.ajax({url:"/api/blog/upvote?bid="+t,type:"POST",contentType:"application/json",dataType:"json",success:function(b){if(b.state===0){narn("success","点赞成功！")}else{narn("log","您现在不能投票！")}}})}else{$.ajax({url:"/api/blog/comments/upvote?bid="+bid+"&id="+a,type:"POST",contentType:"application/json",dataType:"json",success:function(b){if(b.state===0){narn("success","点赞成功！")}else{narn("log","您现在不能投票！")}}})}}function subStar(a){if(a===0||bid===-1){let t=bid===-1?a:bid;$.ajax({url:"/api/blog/downvote?bid="+t,type:"POST",contentType:"application/json",dataType:"json",success:function(b){if(b.state===0){narn("success","点踩成功")}else{narn("log","您现在不能投票")}}})}else{$.ajax({url:"/api/blog/comments/downvote?bid="+bid+"&id="+a,type:"POST",contentType:"application/json",dataType:"json",success:function(b){if(b.state===0){narn("success","点踩成功")}else{narn("log","您现在不能投票")}}})}}function collect(){$.ajax({url:"/api/problem/collect?pid="+pid,type:"POST",contentType:"application/json",dataType:"json",success:function(a){if(a.state===0){if($("#problemIsCollection").find("font").length===0){$("#problemIsCollection").html('<font color="green"><span class="glyphicon glyphicon-star"></span>已收藏</font>');narn("success","成功收藏")}else{$("#problemIsCollection").html("<span class='glyphicon glyphicon-star-empty'></span>收藏");narn("log","成功取消收藏")}}else{narn("log","未知错误")}}})}let isLoadTags=false;function loadTags(){if(!isLoadTags){isLoadTags=true;$.getJSON("/api/problem/tags",function(a){let t=$("#tagSelect");for(let i=0;i<a.length;i++){t.append(HTML.optionValue(a[i].tid,a[i].name))}})}}function addTag(){let tag=$("#tagSelect option:selected").val();if(tag===-1){narn("log","请选择一个标签进行添加！")}else{$.ajax({url:"/api/problem/add/tag?pid="+pid,type:"POST",contentType:"application/json",dataType:"json",data:JSON.stringify({tag:tag}),success:function(a){if(a.state===0){narn("success","标签添加成功")}else{if(a.state===1){narn("log","您还没有登陆！")}else{if(a.state===2){narn("log","您还没有AC本题，无法添加标签")}else{if(a.state===3){narn("log","您已经添加过这个标签了")}}}}}})}}function loadTab3(){let table=$("#tab3 table tbody");$.getJSON($("#judgeUrl").val()+"/api/problem/down/"+pid+"?token="+$("#token").val(),function(a){if(a.state!==0){narn("log","题目数据获取失败！");return}for(let i=0;i<a.data.length;i++){table.append(HTML.tr(HTML.td(a.data[i].name)+HTML.td(HTML.a(a.data[i].link+"&token="+$("#token").val(),"点击下载"))))}})}function addSlashes(a){a=a.replace(/\\/g,"\\\\");a=a.replace(/\"/g,'\\"');return a};